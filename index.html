<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unlabel: Health & Nature Theme</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-start: #f0fdfa; /* Light Green */
            --background-end: #f0f9ff;   /* Light Blue */
            --accent-color: #10b981;     /* Emerald-500 */
            --accent-hover: #059669;    /* Emerald-600 */
        }
        html.dark {
            --background-start: #042f2e; /* Deep Teal */
            --background-end: #111827;   /* Dark Gray */
            --accent-color: #34d399;     /* Emerald-400 */
            --accent-hover: #6ee7b7;    /* Emerald-300 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-image: linear-gradient(to top, var(--background-end), var(--background-start));
            transition: background-image 0.5s ease;
        }
        .loader {
            border: 4px solid rgba(0,0,0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--accent-color);
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .btn-primary {
            background-color: var(--accent-color);
            color: white;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: var(--accent-hover);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
            transform: translateY(-2px);
        }
        .content-card {
            background: white;
        }
        html.dark .content-card {
            background: #1e293b; /* Slate-800 */
            border: 1px solid #334155; /* Slate-700 */
        }
        /* Modal styles */
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 9999px;
            border: 1px solid #d1d5db; /* gray-300 */
            transition: all 0.2s ease-in-out;
            background-color: #f1f5f9; /* slate-100 */
        }
        html.dark .checkbox-label {
            border: 1px solid #475569; /* slate-600 */
            background-color: #334155; /* slate-700 */
        }
        .checkbox-label:hover {
            border-color: var(--accent-hover);
        }
        .checkbox-input:checked + .checkbox-label {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        .checkbox-input:checked + .checkbox-label:hover {
            background-color: var(--accent-hover);
        }
    </style>
</head>
<body class="text-slate-900 dark:text-slate-200">

    <div class="container mx-auto max-w-2xl p-4 sm:p-6 min-h-screen">
        <header class="text-center mb-8 pt-4">
            <h1 class="text-6xl font-black text-emerald-900 dark:text-emerald-300">Unlabel</h1>
            <p class="text-lg text-slate-600 dark:text-slate-300 mt-2">A fresh look at what you eat.</p>
        </header>

        <nav class="flex justify-center border-b border-slate-200 dark:border-slate-700 mb-8">
            <button id="tab-scan" class="tab font-semibold py-3 px-6 text-slate-500 dark:text-slate-400 border-b-2 border-transparent hover:text-[--accent-color] transition-colors">Scan</button>
            <button id="tab-history" class="tab font-semibold py-3 px-6 text-slate-500 dark:text-slate-400 border-b-2 border-transparent hover:text-[--accent-color] transition-colors">History</button>
            <button id="tab-profile" class="tab font-semibold py-3 px-6 text-slate-500 dark:text-slate-400 border-b-2 border-transparent hover:text-[--accent-color] transition-colors">Profile</button>
        </nav>

        <main id="app-container">
            <!-- All views are contained here -->
        </main>
    </div>

    <!-- Modal for Gemini Features -->
    <div id="gemini-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 modal-backdrop hidden" style="opacity: 0;">
        <div class="w-full max-w-lg content-card rounded-2xl shadow-2xl p-6 modal-content" style="transform: scale(0.95); opacity: 0;">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-slate-800 dark:text-white"></h3>
                <button id="modal-close-button" class="text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div id="modal-body" class="max-h-[60vh] overflow-y-auto pr-2">
                <!-- Content from Gemini will be injected here -->
            </div>
        </div>
    </div>

    <script>
    // --- Application State & Configuration ---
    let state = {
        currentView: 'scan',
        history: [],
        profile: { dietary_preferences: '', dietary_labels: [] },
        activeChart: null,
        currentAnalysis: null,
        currentChartType: 'macronutrients',
    };
    const apiKey = "AIzaSyCwYLCKyo5NMNMUWgaKjlVb-Hv8UTvnBnk"; // Handled by the environment

    // --- DOM Element Selection ---
    const appContainer = document.getElementById('app-container');
    const geminiModal = document.getElementById('gemini-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const modalCloseButton = document.getElementById('modal-close-button');

    // --- Core Application Logic ---

    function initApp() {
        initTheme();
        loadStateFromStorage();
        setupEventListeners();
        showView('scan');
    }

    function setupEventListeners() {
        modalCloseButton.addEventListener('click', closeModal);
        geminiModal.addEventListener('click', (e) => {
            if (e.target === geminiModal) closeModal();
        });
    }
    
    // --- Theme Management ---
    function initTheme() {
        const userTheme = localStorage.getItem('theme');
        const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        setTheme(userTheme || systemTheme);
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            setTheme(e.matches ? 'dark' : 'light');
        });
    }

    function setTheme(theme) {
        document.documentElement.classList.toggle('dark', theme === 'dark');
        localStorage.setItem('theme', theme);
        if (state.activeChart) {
            state.activeChart.destroy();
        }
    }

    function showView(viewName) {
        state.currentView = viewName;
        if (state.activeChart) {
            state.activeChart.destroy();
            state.activeChart = null;
        }

        let viewHtml = '';
        switch(viewName) {
            case 'scan': viewHtml = getScanViewHtml(); break;
            case 'history': viewHtml = getHistoryViewHtml(); break;
            case 'profile': viewHtml = getProfileViewHtml(); break;
        }
        appContainer.innerHTML = viewHtml;

        // Update active tab styles
        document.querySelectorAll('.tab').forEach(tab => {
            const tabName = tab.id.split('-')[1];
            const isActive = tabName === viewName;
            tab.style.color = isActive ? 'var(--accent-color)' : '';
            tab.style.borderColor = isActive ? 'var(--accent-color)' : 'transparent';
        });
        
        addEventListenersForView(viewName);
    }
    
    function addEventListenersForView(viewName) {
        document.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', () => showView(tab.id.split('-')[1])));
        if (viewName === 'scan') {
            document.getElementById('open-camera-button').addEventListener('click', handleOpenCamera);
            document.getElementById('upload-image-button').addEventListener('click', () => document.getElementById('image-upload-input').click());
            document.getElementById('image-upload-input').addEventListener('change', handleImageUpload);
            document.getElementById('close-camera-button').addEventListener('click', handleCloseCamera);
            document.getElementById('scan-button').addEventListener('click', handleScan);
            handleCloseCamera();
        }
        if (viewName === 'history') {
            renderHistory();
        }
        if (viewName === 'profile') {
            renderProfile();
            document.getElementById('save-profile-button').addEventListener('click', handleProfileSave);
        }
    }

    // --- Local Storage Persistence ---
    function loadStateFromStorage() {
        const history = localStorage.getItem('labelLensHistory');
        const profile = localStorage.getItem('labelLensProfile');
        if (history) state.history = JSON.parse(history);
        if (profile) state.profile = JSON.parse(profile);
    }
    function saveHistoryToStorage() { localStorage.setItem('labelLensHistory', JSON.stringify(state.history)); }
    function saveProfileToStorage() { localStorage.setItem('labelLensProfile', JSON.stringify(state.profile)); }

    // --- Camera & Scanning Logic ---
    function handleOpenCamera() {
        document.getElementById('camera-off-view').classList.add('hidden');
        document.getElementById('camera-on-view').classList.remove('hidden');
        initCamera();
    }
    function handleCloseCamera() {
        stopCamera();
        document.getElementById('camera-on-view').classList.add('hidden');
        document.getElementById('camera-off-view').classList.remove('hidden');
    }
    async function initCamera() {
        const video = document.getElementById('video');
        const scanButton = document.getElementById('scan-button');
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            scanButton.disabled = true;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                video.onloadedmetadata = () => { scanButton.disabled = false; };
            } catch (err) {
                console.error("Camera access error:", err);
                document.getElementById('camera-permission-message').textContent = "Camera access denied. Please enable camera permissions.";
                handleCloseCamera();
            }
        }
    }
    function stopCamera() {
        const video = document.getElementById('video');
        if (video && video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        }
    }
    
    async function handleScan() {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageDataUrl = canvas.toDataURL('image/png');
        processImageAndAnalyze(imageDataUrl);
    }

    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                processImageAndAnalyze(e.target.result);
            };
            reader.readAsDataURL(file);
        }
    }
    
    function handleRetake() {
        // Hide results and show scanner view
        document.getElementById('results-view').classList.add('hidden');
        document.getElementById('scanner-view').classList.remove('hidden');
        
        // Reset analysis state for a new scan
        state.currentAnalysis = null;
        
        // Ensure camera is stopped if it was running, and then re-show the "off" view
        handleCloseCamera();
    }

    async function processImageAndAnalyze(imageDataUrl) {
        document.getElementById('scanner-view').classList.add('hidden');
        document.getElementById('results-view').classList.remove('hidden');
        document.getElementById('captured-image').src = imageDataUrl;
        document.getElementById('loader').style.display = 'flex';
        document.getElementById('analysis-results').innerHTML = '';
        document.getElementById('error-message').classList.add('hidden');
        stopCamera();

        const base64ImageData = imageDataUrl.split(',')[1];
        const analysisData = await callGemini(getAnalysisPrompt(base64ImageData));
        
        if (analysisData) {
            state.currentAnalysis = analysisData;
            const dietaryAlerts = await checkForDietaryConflicts(analysisData);
            renderAnalysis(analysisData, dietaryAlerts);
            const scanRecord = { id: Date.now(), timestamp: new Date().toISOString(), imageDataUrl, analysis: analysisData, alerts: dietaryAlerts };
            state.history.unshift(scanRecord);
            saveHistoryToStorage();
        }
    }
    
    // --- Gemini API Interaction ---
    async function callGemini(payload) {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        let retries = 0;
        const maxRetries = 5;
        let delay = 1000;
        
        while (retries < maxRetries) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    if (response.status === 429) { // Too Many Requests
                        retries++;
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // Exponential backoff
                        continue;
                    }
                    throw new Error(`API request failed: ${response.statusText}`);
                }
                
                const result = await response.json();
                const textResponse = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!textResponse) {
                    throw new Error("Invalid API response format: No text content found.");
                }

                console.log("Raw API Response:", textResponse); // Log the raw response

                try {
                    return JSON.parse(textResponse);
                } catch (parseError) {
                    console.error("JSON parsing error:", parseError);
                    const errorMessage = document.getElementById('error-message');
                    if (errorMessage) {
                        errorMessage.textContent = "Could not parse AI response. Please try again. (Invalid JSON format received)";
                        errorMessage.classList.remove('hidden');
                    }
                    const loader = document.getElementById('loader');
                    if (loader) loader.style.display = 'none';
                    // Return a default, valid object to prevent crashes
                    return {
                        "product_name": "Analysis Failed",
                        "product_category": "Error",
                        "summary": "The AI could not process the label due to an invalid response format.",
                        "health_score": "N/A",
                        "health_score_category": "Poor",
                        "pros": [],
                        "cons": [],
                        "ingredients": [],
                        "unhealthy_ingredients": [],
                        "allergens": [],
                        "recycling_info": "No information available.",
                        "nutritional_info": null,
                        "main_ingredients": [],
                        "dietary_labels": [],
                        "ai_vegetarian_status": "Not Sure"
                    };
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                const errorMessage = document.getElementById('error-message');
                if(errorMessage) {
                    errorMessage.textContent = `Could not get a response from the AI. Please try again. (Error: ${error.message})`;
                    errorMessage.classList.remove('hidden');
                }
                const loader = document.getElementById('loader');
                if(loader) loader.style.display = 'none';
                return null;
            }
        }
        return null;
    }

    function getAnalysisPrompt(base64ImageData) {
        const prompt = `You are an expert product label analyst. Analyze the provided image and return a JSON object with this exact schema: 
{"product_name": "Product name", "product_category": "A general category", "summary": "A brief, one-sentence summary.", "health_score": "A score from 1 to 10 (e.g., '7/10').", "health_score_category": "Category: 'Excellent' (9-10), 'Good' (7-8), 'Moderate' (4-6), or 'Poor' (1-3).", "pros": ["List of positive aspects. Return an empty array if none are found."], "cons": ["List of aspects to be cautious about. Return an empty array if none are found."], "ingredients": ["A full list of all ingredients detected, in order of quantity. If no ingredients are found, return an empty array."], "unhealthy_ingredients": [{"ingredient": "Name of unhealthy/banned ingredient", "reason": "Brief explanation of risk."}], "allergens": ["List of common allergens found. Return an empty array if none are found."], "recycling_info": "Describe any recycling information.", "nutritional_info": {"proteins_percent": 20, "fats_percent": 15, "carbs_percent": 65}, "main_ingredients": [{"name": "Ingredient name", "quantity_percent": 50}], "dietary_labels": ["List of dietary or religious labels found, like 'Vegetarian', 'Vegan', 'Halal'. Return an empty array if none are found."], "ai_vegetarian_status": "A determination of vegetarian suitability based on ingredients. Use one of these exact strings: 'Likely Vegetarian', 'Likely Vegan', 'Not Vegetarian', or 'Not Sure'."}
The quantity_percent for main ingredients is an approximate percentage of the product's total composition, focusing on the most prominent ingredients. The 'ingredients' array should list every single ingredient, regardless of quantity.
Respond ONLY with the valid JSON object.`;
        return { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64ImageData } }] }], generationConfig: { "responseMimeType": "application/json" } };
    }

    async function checkForDietaryConflicts(analysisData) {
        let alerts = [];
        const preferences = state.profile.dietary_preferences.split(',').map(s => s.trim().toLowerCase()).filter(s => s);
        if (preferences.length > 0 && analysisData.ingredients && analysisData.ingredients.length > 0) {
            const prompt = `User restrictions: "${preferences.join(', ')}". Product ingredients: "${analysisData.ingredients.join(', ')}". Are there any conflicts? Respond with a JSON object: {"conflicts": ["Description of each conflict."]}. If none, return {"conflicts": []}. Respond ONLY with the valid JSON object.`;
            const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { "responseMimeType": "application/json" } };
            const result = await callGemini(payload);
            if (result && result.conflicts) {
                alerts.push(...result.conflicts);
            } else {
                 alerts.push("Could not verify custom dietary conflicts due to an error.");
            }
        }
        
        const preferredLabels = state.profile.dietary_labels || [];
        const detectedLabels = analysisData.dietary_labels || [];
        if (preferredLabels.length > 0) {
            for (const label of preferredLabels) {
                if (!detectedLabels.some(d => d.toLowerCase() === label.toLowerCase())) {
                    alerts.push(`This product is not labeled as "${label}".`);
                }
            }
        }
        return alerts;
    }
    
    // --- New Gemini Features ---
    async function handleGetRecipe() {
        if (!state.currentAnalysis) return;
        openModal("✨ Recipe Idea", "<div class='loader mx-auto'></div>");
        const prompt = `Generate a simple, healthy recipe using "${state.currentAnalysis.product_name}". Respond with a JSON object with keys: "title", "description" (string), "ingredients" (array of strings), and "instructions" (array of strings). Respond ONLY with the valid JSON object.`;
        const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { "responseMimeType": "application/json" } };
        const recipe = await callGemini(payload);
        if (recipe) {
            modalBody.innerHTML = `
                <h4 class="text-lg font-bold text-slate-800 dark:text-white">${recipe.title}</h4>
                <p class="text-sm text-slate-600 dark:text-slate-300 mt-1 mb-4">${recipe.description}</p>
                <div class="space-y-4">
                    <div>
                        <h5 class="font-semibold text-slate-800 dark:text-white">Ingredients</h5>
                        <ul class="list-disc list-inside text-slate-600 dark:text-slate-300">
                            ${recipe.ingredients.map(i => `<li>${i}</li>`).join('')}
                        </ul>
                    </div>
                    <div>
                        <h5 class="font-semibold text-slate-800 dark:text-white">Instructions</h5>
                        <ol class="list-decimal list-inside text-slate-600 dark:text-slate-300 space-y-1">
                            ${recipe.instructions.map(i => `<li>${i}</li>`).join('')}
                        </ol>
                    </div>
                </div>
            `;
        }
    }

    async function handleGetAlternatives() {
        if (!state.currentAnalysis) return;
        openModal("✨ Healthier Alternatives", "<div class='loader mx-auto'></div>");
        const prompt = `The user scanned "${state.currentAnalysis.product_name}". Suggest 3 healthier alternatives commonly available. For each, provide a "name" and a "reason" why it's healthier. Respond with a JSON object with a key "alternatives" which is an array of objects. Respond ONLY with the valid JSON object.`;
        const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { "responseMimeType": "application/json" } };
        const alternatives = await callGemini(payload);
        if (alternatives && alternatives.alternatives) {
            modalBody.innerHTML = `
                <div class="space-y-3">
                    ${alternatives.alternatives.map(alt => `
                        <div class="p-3 bg-slate-100 dark:bg-slate-700/50 rounded-lg">
                            <p class="font-semibold text-slate-800 dark:text-white">${alt.name}</p>
                            <p class="text-sm text-slate-600 dark:text-slate-300">${alt.reason}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }
    }

    async function handleGetNutritionInfo() {
      if (!state.currentAnalysis) return;
      openModal("✨ Nutritional Breakdown", "<div class='loader mx-auto'></div>");
      const prompt = `Generate a detailed nutritional breakdown for the product "${state.currentAnalysis.product_name}". Provide a list of key nutrients (calories, fats, carbs, protein, vitamins, minerals) and their values per serving. Include the bio daily requirement percentage for each. Respond with a JSON object with keys: "title", "serving_size", and "nutrients" (an array of objects with "name", "value", "unit", and "daily_value_percent" keys). Respond ONLY with the valid JSON object.`;
      const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { "responseMimeType": "application/json" } };
      const nutrition = await callGemini(payload);
      if (nutrition) {
          modalBody.innerHTML = `
              <h4 class="text-lg font-bold text-slate-800 dark:text-white">${nutrition.title}</h4>
              <p class="text-sm text-slate-600 dark:text-slate-300 mt-1 mb-4">Serving Size: ${nutrition.serving_size}</p>
              <ul class="space-y-2 text-sm text-slate-600 dark:text-slate-300">
                  ${nutrition.nutrients.map(n => `<li><span class="font-semibold text-slate-800 dark:text-white">${n.name}:</span> ${n.value} ${n.unit} (${n.daily_value_percent}% daily value)</li>`).join('')}
              </ul>
          `;
      }
    }


    // --- UI Rendering ---
    function renderAnalysis(data, alerts = []) {
        document.getElementById('loader').style.display = 'none';
        const analysisResults = document.getElementById('analysis-results');
        const healthRisks = (data.unhealthy_ingredients || []).map(item => `${item.ingredient}: ${item.reason}`);
        const scoreCategory = data.health_score_category || '';
        let scoreColorClass = 'text-slate-800 dark:text-slate-200';
        switch(scoreCategory.toLowerCase()) {
            case 'excellent': scoreColorClass = 'text-green-500 dark:text-green-400'; break;
            case 'good': scoreColorClass = 'text-emerald-500 dark:text-emerald-400'; break;
            case 'moderate': scoreColorClass = 'text-amber-500 dark:text-amber-400'; break;
            case 'poor': scoreColorClass = 'text-red-500 dark:text-red-400'; break;
        }

        const isFood = !['cleaning', 'cosmetic', 'personal care'].some(cat => data.product_category.toLowerCase().includes(cat));
        
        // Logic to display detected dietary labels with emojis
        let detectedLabelsContent = '';
        if (data.dietary_labels && data.dietary_labels.length > 0) {
            const formattedLabels = data.dietary_labels.map(label => {
                const lowerLabel = label.toLowerCase();
                if (lowerLabel === 'vegetarian') return '🌱 Vegetarian';
                if (lowerLabel === 'vegan') return '🌿 Vegan';
                if (lowerLabel === 'halal') return '☪️ Halal';
                if (lowerLabel === 'kosher') return '✡️ Kosher';
                return label; // Fallback for any other labels
            });
            detectedLabelsContent = createCard('Detected Dietary Labels', formattedLabels, 'blue');
        }

        // Logic for personalized profile alerts
        let dietaryLabelContent = '';
        const preferredLabels = state.profile.dietary_labels || [];
        if (preferredLabels.length > 0) {
            const unmatchedLabels = preferredLabels.filter(label => !data.dietary_labels.some(d => d.toLowerCase() === label.toLowerCase()));
            if (unmatchedLabels.length > 0) {
                dietaryLabelContent = createCard(`Label Mismatch`, unmatchedLabels.map(l => `This product is not labeled as "${l}".`), 'red');
            } else {
                dietaryLabelContent = createCard(`Labels Matched`, preferredLabels, 'green');
            }
        }

        // Logic for AI-based vegetarian/vegan status
        let aiDietaryStatusContent = '';
        if (data.ai_vegetarian_status && data.ai_vegetarian_status !== 'Not Sure') {
            const isPositive = data.ai_vegetarian_status.includes('Likely');
            const color = isPositive ? 'green' : 'red';
            const icon = isPositive ? '✅' : '❌';
            aiDietaryStatusContent = createCard(`AI-Based Dietary Suggestion`, [
                `${icon} This product is **${data.ai_vegetarian_status}** based on the ingredients.`,
                `*Disclaimer: This is an AI-generated analysis and is not a certified label. Always consult a professional for medical or dietary advice.*`
            ], color);
        } else if (data.ai_vegetarian_status === 'Not Sure') {
            aiDietaryStatusContent = createCard(`AI-Based Dietary Suggestion`, [
                `This product's dietary status is **Not Sure** based on the ingredients.`,
                `*Disclaimer: This is an AI-generated analysis and is not a certified label. Always consult a professional for medical or dietary advice.*`
            ], 'yellow');
        }
        

        analysisResults.innerHTML = `
            <div class="flex justify-end mb-4">
                <button id="retake-button" class="bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 font-semibold py-2 px-4 rounded-xl flex items-center justify-center gap-2 hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 1-9 9m-9-9a9 9 0 0 1 9-9"/><path d="M12 4V2"/><path d="M16.2 7.8l1.4-1.4"/><path d="M20 12h2"/><path d="M16.2 16.2l1.4 1.4"/><path d="M12 20v2"/><path d="M7.8 16.2l-1.4 1.4"/><path d="M4 12H2"/><path d="M7.8 7.8l-1.4-1.4"/></svg>
                    <span>Retake</span>
                </button>
            </div>
            ${aiDietaryStatusContent}
            ${dietaryLabelContent}
            ${detectedLabelsContent}
            ${alerts.length > 0 ? createCard('Personalized Alerts', alerts, 'red') : ''}
            ${healthRisks.length > 0 ? createCard('Health Risks Identified', healthRisks, 'red') : ''}
            <div class="fade-in content-card rounded-2xl shadow-lg p-6">
                <p class="text-sm font-semibold uppercase tracking-wider" style="color: var(--accent-color);">${data.product_category || 'Uncategorized'}</p>
                <h3 class="text-2xl font-bold text-slate-800 dark:text-white -mt-1">${data.product_name || 'Product Analysis'}</h3>
                <p class="text-slate-600 dark:text-slate-300 mt-2">${data.summary || 'No summary available.'}</p>
            </div>
            
            <div class="fade-in grid grid-cols-1 sm:grid-cols-2 gap-3">
                <button id="get-alternatives-btn" class="content-card p-3 rounded-xl font-semibold text-center transition hover:scale-105 hover:shadow-xl" style="color: var(--accent-color);">✨ Find Healthier Alternatives</button>
                ${isFood ? `<button id="get-recipe-btn" class="content-card p-3 rounded-xl font-semibold text-center transition hover:scale-105 hover:shadow-xl" style="color: var(--accent-color);">✨ Get Recipe Idea</button>` : ''}
            </div>

            <div class="fade-in text-center content-card rounded-2xl shadow-lg p-6">
                <h4 class="text-sm font-medium text-slate-600 dark:text-slate-400">Overall Health Score</h4>
                <p class="text-6xl font-extrabold ${scoreColorClass}">${data.health_score || 'N/A'}</p>
                <p class="font-semibold ${scoreColorClass} -mt-1">${scoreCategory}</p>
            </div>
            
            ${(data.nutritional_info || data.main_ingredients) ? `
            <div class="fade-in content-card rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h4 id="chart-title" class="font-bold text-slate-800 dark:text-white"></h4>
                    ${(data.nutritional_info && data.main_ingredients && data.main_ingredients.length > 0) ? `
                        <button id="toggle-chart-btn" class="font-semibold text-sm hover:underline" style="color: var(--accent-color);"></button>` : ''}
                </div>
                <div class="w-full max-w-sm mx-auto"><canvas id="composition-chart"></canvas></div>
                <div class="mt-4 text-center">
                    <button id="get-nutrition-btn" class="font-semibold text-sm hover:underline" style="color: var(--accent-color);">View Full Nutritional Breakdown</button>
                </div>
            </div>` : ''}

            <div class="grid md:grid-cols-2 gap-5">
                ${createCard('Pros', data.pros, 'green')}
                ${createCard('Cons', data.cons, 'orange')}
            </div>
            ${createCard('Allergen Info', data.allergens, 'yellow')}
            ${createCard('Full Ingredient List', data.ingredients, 'gray')}
            ${createCard('Recycling & Sustainability', [data.recycling_info], 'blue')}
        `;
        
        if (data.nutritional_info || data.main_ingredients) {
            document.getElementById('get-nutrition-btn').addEventListener('click', handleGetNutritionInfo);
            if (document.getElementById('toggle-chart-btn')) {
                document.getElementById('toggle-chart-btn').addEventListener('click', toggleChart);
            }
            if (data.main_ingredients && data.main_ingredients.length > 0) {
                state.currentChartType = 'ingredients';
            } else {
                state.currentChartType = 'macronutrients';
            }
            renderCurrentChart();
        }

        document.getElementById('get-alternatives-btn').addEventListener('click', handleGetAlternatives);
        if(isFood) {
            document.getElementById('get-recipe-btn').addEventListener('click', handleGetRecipe);
        }
        
        // Add event listener for the new retake button
        document.getElementById('retake-button').addEventListener('click', handleRetake);
    }
    
    function renderCurrentChart() {
        if (!state.currentAnalysis) return;

        const chartTitle = document.getElementById('chart-title');
        const toggleBtn = document.getElementById('toggle-chart-btn');
        const isDark = document.documentElement.classList.contains('dark');
        const colors = [isDark ? '#60a5fa' : '#3b82f6', isDark ? '#fb7185' : '#f43f5e', isDark ? '#fcd34d' : '#f59e0b', isDark ? '#93c5fd' : '#2563eb', isDark ? '#fda4af' : '#e11d48', isDark ? '#fde047' : '#d97706'];
        
        if (state.activeChart) {
            state.activeChart.destroy();
        }

        if (state.currentChartType === 'macronutrients' && state.currentAnalysis.nutritional_info) {
            chartTitle.textContent = 'Macronutrient Composition';
            if (toggleBtn) toggleBtn.textContent = 'Show Ingredients';
            const data = [
                state.currentAnalysis.nutritional_info.carbs_percent,
                state.currentAnalysis.nutritional_info.proteins_percent,
                state.currentAnalysis.nutritional_info.fats_percent
            ];
            const labels = ['Carbohydrates', 'Proteins', 'Fats'];
            renderPieChart(labels, data, [colors[0], colors[1], colors[2]], false);
        } else if (state.currentChartType === 'ingredients' && state.currentAnalysis.main_ingredients && state.currentAnalysis.main_ingredients.length > 0) {
            chartTitle.textContent = 'Main Ingredient Composition (Approximate)';
            if (toggleBtn) toggleBtn.textContent = 'Show Macronutrients';
            const labels = state.currentAnalysis.main_ingredients.map(ing => ing.name);
            const data = state.currentAnalysis.main_ingredients.map(ing => ing.quantity_percent);
            renderPieChart(labels, data, colors, true);
        } else {
            chartTitle.textContent = 'Composition Not Available';
            if (toggleBtn) toggleBtn.style.display = 'none';
        }
    }

    function toggleChart() {
        if (state.currentChartType === 'macronutrients') {
            state.currentChartType = 'ingredients';
        } else {
            state.currentChartType = 'macronutrients';
        }
        renderCurrentChart();
    }
    
    function renderPieChart(labels, data, colors, isApproximate = false) {
        const ctx = document.getElementById('composition-chart');
        if (!ctx) return;
        const isDark = document.documentElement.classList.contains('dark');

        state.activeChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{ 
                    data: data,
                    backgroundColor: colors,
                    borderColor: isDark ? '#1e293b' : '#ffffff',
                    borderWidth: 2
                }]
            },
            options: { 
                responsive: true, 
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: isDark ? '#cbd5e1' : '#475569',
                            font: { size: 14 }
                        }
                    },
                    tooltip: { 
                        bodyFont: { size: 14 }, 
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    const value = isApproximate ? `~${context.parsed}` : context.parsed;
                                    label += value + '%';
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    function createCard(title, items, color) {
        if (!items || (Array.isArray(items) && items.length === 0) || (Array.isArray(items) && items.length === 1 && !items[0])) {
            return '';
        }
        const colors = {
            green: { border: 'border-green-500 dark:border-green-400', text: 'text-green-800 dark:text-green-300' },
            red: { border: 'border-red-500 dark:border-red-400', text: 'text-red-800 dark:text-red-300' },
            orange: { border: 'border-orange-500 dark:border-orange-400', text: 'text-orange-800 dark:text-orange-300' },
            yellow: { border: 'border-amber-500 dark:border-amber-400', text: 'text-amber-800 dark:text-amber-300' },
            blue: { border: 'border-sky-500 dark:border-sky-400', text: 'text-sky-800 dark:text-sky-300' },
            gray: { border: 'border-slate-400 dark:border-slate-500', text: 'text-slate-800 dark:text-slate-200' }
        };
        const c = colors[color] || colors.gray;
        const iconMap = {
            '🌱': 'text-green-500 dark:text-green-400',
            '🌿': 'text-green-500 dark:text-green-400',
            '☪️': 'text-blue-500 dark:text-blue-400',
            '✡️': 'text-blue-500 dark:text-blue-400',
            '❌': 'text-red-500 dark:text-red-400',
            '✅': 'text-green-500 dark:text-green-400',
            '⚠️': 'text-amber-500 dark:text-amber-400'
        };

        return `<div class="fade-in content-card rounded-2xl shadow-lg p-5 border-l-4 ${c.border}">
                <h4 class="font-bold ${c.text}">${title}</h4>
                <ul class="mt-2 ml-1 text-sm list-disc list-inside text-slate-600 dark:text-slate-300">
                    ${items.map(item => {
                        const firstChar = item.trim().charAt(0);
                        const isIcon = ['🌱', '🌿', '☪️', '✡️', '❌', '✅', '⚠️'].includes(firstChar);
                        const iconClass = isIcon ? iconMap[firstChar] : '';
                        const text = isIcon ? item.substring(firstChar.length).trim() : item;
                        return `<li><span class="${iconClass} font-semibold">${isIcon ? firstChar : ''}</span> ${text}</li>`;
                    }).join('')}
                </ul>
            </div>`;
    }

    // --- History View Logic ---
    function renderHistory() {
        const historyList = document.getElementById('history-list');
        const historyEmptyMessage = document.getElementById('history-empty-message');
        if (!historyList) return;
        
        if (state.history.length === 0) {
            historyList.innerHTML = '';
            historyEmptyMessage.classList.remove('hidden');
        } else {
            historyEmptyMessage.classList.add('hidden');
            historyList.innerHTML = state.history.map(item => `
                <div class="history-item flex items-center gap-4 p-4 content-card rounded-2xl shadow-lg">
                    <img src="${item.imageDataUrl}" class="w-16 h-16 object-cover rounded-xl flex-shrink-0">
                    <div class="flex-grow">
                        <p class="font-semibold text-slate-800 dark:text-white">${item.analysis.product_name || 'Unknown Product'}</p>
                        <p class="text-sm text-slate-500 dark:text-slate-400">${new Date(item.timestamp).toLocaleString()}</p>
                    </div>
                    <button class="view-history-btn font-semibold hover:underline" data-id="${item.id}" style="color: var(--accent-color);">View</button>
                    <button class="delete-history-btn text-red-500 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300" data-id="${item.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                    </button>
                </div>
            `).join('');
            document.querySelectorAll('.view-history-btn').forEach(btn => btn.addEventListener('click', handleViewHistoryItem));
            document.querySelectorAll('.delete-history-btn').forEach(btn => btn.addEventListener('click', handleDeleteHistoryItem));
        }
    }
    function handleViewHistoryItem(event) {
        const itemId = Number(event.currentTarget.dataset.id);
        const item = state.history.find(h => h.id === itemId);
        if (item) {
            showView('scan');
            setTimeout(() => {
                document.getElementById('scanner-view').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');
                document.getElementById('loader').style.display = 'none';
                document.getElementById('captured-image').src = item.imageDataUrl;
                state.currentAnalysis = item.analysis;
                renderAnalysis(item.analysis, item.alerts);
            }, 10);
        }
    }
    function handleDeleteHistoryItem(event) {
        const itemId = Number(event.currentTarget.dataset.id);
        state.history = state.history.filter(h => h.id !== itemId);
        saveHistoryToStorage();
        renderHistory();
    }

    // --- Profile View Logic ---
    function renderProfile() { 
        const dietaryPrefsInput = document.getElementById('dietary-prefs');
        if (dietaryPrefsInput) dietaryPrefsInput.value = state.profile.dietary_preferences; 
        
        const dietaryLabels = ['Vegetarian', 'Vegan', 'Halal', 'Kosher'];
        dietaryLabels.forEach(label => {
            const checkbox = document.getElementById(`label-${label.toLowerCase()}`);
            if (checkbox) {
                checkbox.checked = state.profile.dietary_labels.includes(label);
            }
        });
    }
    function handleProfileSave() {
        const dietaryPrefsInput = document.getElementById('dietary-prefs');
        const profileSavedMessage = document.getElementById('profile-saved-message');
        
        // Save custom preferences
        state.profile.dietary_preferences = dietaryPrefsInput.value.trim();

        // Save dietary label preferences
        state.profile.dietary_labels = [];
        document.querySelectorAll('input[name="dietary-label"]:checked').forEach(checkbox => {
            state.profile.dietary_labels.push(checkbox.value);
        });

        saveProfileToStorage();
        profileSavedMessage.classList.remove('hidden');
        setTimeout(() => profileSavedMessage.classList.add('hidden'), 2000);
    }
    
    // --- Modal Logic ---
    function openModal(title, content) {
        modalTitle.textContent = title;
        modalBody.innerHTML = content;
        geminiModal.classList.remove('hidden');
        setTimeout(() => {
            geminiModal.style.opacity = '1';
            geminiModal.querySelector('.modal-content').style.transform = 'scale(1)';
            geminiModal.querySelector('.modal-content').style.opacity = '1';
        }, 10);
    }
    function closeModal() {
        geminiModal.style.opacity = '0';
        geminiModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
        geminiModal.querySelector('.modal-content').style.opacity = '0';
        setTimeout(() => geminiModal.classList.add('hidden'), 300);
    }

    // --- HTML String Templates for Views ---
    function getScanViewHtml() {
        return `
            <div id="scanner-view">
                <div id="camera-off-view" class="text-center p-8 content-card rounded-2xl shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-slate-400 dark:text-slate-500 mb-4"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
                    <p id="camera-permission-message" class="text-slate-500 dark:text-slate-400 mb-6">Use your camera or upload an image to start.</p>
                    <div class="flex flex-col sm:flex-row gap-3 justify-center">
                        <button id="open-camera-button" class="btn-primary font-bold py-3 px-6 rounded-full shadow-md flex items-center justify-center gap-2">Open Camera</button>
                        <button id="upload-image-button" class="bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 font-bold py-3 px-6 rounded-full flex items-center justify-center gap-2">Upload Image</button>
                        <input type="file" id="image-upload-input" class="hidden" accept="image/*">
                    </div>
                </div>
                <div id="camera-on-view" class="hidden">
                    <div class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-2xl p-4 mb-4 content-card">
                        <video id="video" class="rounded-xl" autoplay playsinline></video>
                        <canvas id="canvas" class="hidden"></canvas>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button id="scan-button" class="btn-primary w-full font-bold py-3 px-4 rounded-xl shadow-md flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M7 12h10"/></svg>
                            <span>Analyze Label</span>
                        </button>
                        <button id="close-camera-button" class="w-full sm:w-auto bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 font-semibold py-3 px-4 rounded-xl hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors flex items-center justify-center gap-2">Close</button>
                    </div>
                </div>
            </div>
            <div id="results-view" class="hidden">
                    <div class="mb-6"><img id="captured-image" class="rounded-2xl w-full h-auto shadow-xl" alt="Captured product label"></div>
                    <div id="loader" class="flex flex-col items-center justify-center text-center p-8"><div class="loader"></div><p class="mt-4 text-slate-600 dark:text-slate-300 font-medium text-lg">Analyzing label...</p></div>
                    <div id="error-message" class="hidden bg-red-100 dark:bg-red-900/50 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-300 px-4 py-3 rounded-xl" role="alert"></div>
                    <div id="analysis-results" class="space-y-5"></div>
            </div>
        `;
    }
    function getHistoryViewHtml() {
        return `<div id="history-list" class="space-y-4"></div><p id="history-empty-message" class="text-center text-slate-500 dark:text-slate-400 py-12 content-card rounded-2xl shadow-lg">You have no saved scans.</p>`;
    }
    function getProfileViewHtml() {
        return `<div class="content-card rounded-2xl shadow-lg p-6 sm:p-8">
                <h2 class="text-2xl font-bold mb-4 text-slate-800 dark:text-white">My Profile</h2>
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Dietary Labels</label>
                        <div class="flex flex-wrap gap-2">
                            <input type="checkbox" id="label-vegetarian" name="dietary-label" value="Vegetarian" class="hidden checkbox-input">
                            <label for="label-vegetarian" class="checkbox-label">
                                <span class="text-sm font-medium">🌱 Vegetarian</span>
                            </label>
                            <input type="checkbox" id="label-vegan" name="dietary-label" value="Vegan" class="hidden checkbox-input">
                            <label for="label-vegan" class="checkbox-label">
                                <span class="text-sm font-medium">🌿 Vegan</span>
                            </label>
                            <input type="checkbox" id="label-halal" name="dietary-label" value="Halal" class="hidden checkbox-input">
                            <label for="label-halal" class="checkbox-label">
                                <span class="text-sm font-medium">☪️ Halal</span>
                            </label>
                            <input type="checkbox" id="label-kosher" name="dietary-label" value="Kosher" class="hidden checkbox-input">
                            <label for="label-kosher" class="checkbox-label">
                                <span class="text-sm font-medium">✡️ Kosher</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label for="dietary-prefs" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Custom Preferences & Allergies</label>
                        <p class="text-xs text-slate-500 dark:text-slate-400 mb-2">Enter items to avoid, separated by commas (e.g., peanuts, soy, gluten).</p>
                        <input type="text" id="dietary-prefs" class="w-full p-3 bg-white/50 dark:bg-slate-700/50 border border-slate-300 dark:border-slate-600 rounded-xl shadow-sm focus:ring-[--accent-color] focus:border-[--accent-color] transition">
                    </div>
                    <button id="save-profile-button" class="btn-primary font-semibold py-2 px-6 rounded-full shadow-md">Save Profile</button>
                    <p id="profile-saved-message" class="text-green-600 dark:text-green-400 font-medium hidden">Profile saved successfully!</p>
                </div>
            </div>`;
    }
    
    // --- App Initialization ---
    window.addEventListener('load', initApp);
    </script>
</body>
</html>
